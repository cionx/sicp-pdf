\usepackage{microtype}

\usepackage{xstring}

\usepackage[automark]{scrlayer-scrpage}

\usepackage{mathtools}
% Font settings
\RequirePackage[
	% no space around the following equal sign!
	warnings-off={mathtools-colon,mathtools-overbracket},
	partial = upright
]{unicode-math}

\setmainfont[
	Numbers           = OldStyle,
	Mapping           = tex-text,
	SmallCapsFeatures = {LetterSpace=2.5, WordSpace=1.05},
	UprightFont =      {*},
	ItalicFont  =      {* Italic},
	BoldFont    =      {* Bold},
	BoldItalicFont =   {* Bold Italic},
	FontFace = {sb}{n} {* Semibold},
	FontFace = {sb}{it}{* Semibold Italic}
]{Libertinus Serif}

\setsansfont[
	Numbers = OldStyle,
]{Libertinus Sans}

\setmathfont{Libertinus Math}

\setmonofont[
	UprightFont =      {* Medium},
	ItalicFont  =      {* MediumItalic},
	BoldFont    =      {* Bold},
	BoldItalicFont =   {* BoldItalic},
	FontFace = {l}{n}  {* Light},
	FontFace = {l}{it} {* LightItalic},
	FontFace = {sl}{n} {* Regular},
	FontFace = {sl}{it}{* RegularItalic},
	FontFace = {sb}{n} {* SemiBold},
	FontFace = {sb}{it}{* SemiBoldItalic},
	FontFace = {eb}{n} {* ExtraBold},
	FontFace = {eb}{it}{* ExtraBoldItalic},
	FontFace = {ub}{n} {* Black},
	FontFace = {ub}{it}{* BlackItalic},
	Scale = MatchLowercase,
	Contextuals = {AlternateOff},
]
{JuliaMono}

\usepackage{polyglossia}
\setdefaultlanguage[variant=american]{english}
\setotherlanguages{greek}

% To be able to use '\-/' in place of '-' inside \code{}
% so that long function names containing hyphens
% can be broken up after the hyphen:
\usepackage[shortcuts]{extdash}

% So that file names with multiple dots don’t confuse
% graphicx package when using \includegraphics command:
\usepackage[multidot]{grffile}
\usepackage{graphicx}

\usepackage[usenames,dvipsnames,x11names]{xcolor}
\usepackage{amsthm}

\usepackage{menukeys}
\renewmenumacro{\keys}{shadowedroundedkeys}

\usepackage{svg}
\svgsetup{
	inkscapelatex = false
}

\usepackage{minted}

\usepackage{fancyvrb}
\usepackage{imakeidx}
\usepackage[totoc,font=footnotesize]{idxlayout}
\usepackage[final]{pdfpages} % inserts pages from a pdf file
\usepackage[use-files = {true}]{xsim} % to typeset exercises
\usepackage{booktabs}
\usepackage{makecell}
\usepackage{enumitem}  % allows customized labels in enumerations
\usepackage{hyperref}  % makes cross references and URLs clickable
\usepackage[font=small]{caption} % change font size of captions; make links go to the top of the figure/table/… instead of the bottom, where the caption is
\usepackage[noabbrev, capitalize, nameinlink]{cleveref}



% class options
\KOMAoptions{
	fontsize      = 12pt,
	DIV           = 7,
	twoside       = semi,
	chapterprefix = true
}




% default alignment for table cells
\renewcommand{\cellalign}{tl}

% remove numbers from headmark
\renewcommand*{\chaptermarkformat}{\thechapter.\enspace}
\renewcommand*{\sectionmarkformat}{\thesection.\enspace}
% pagenumber in bold
%\addtokomafont{pagenumber}{\bfseries}
% even pages header
\lehead{\pagemark}
\rehead{\upshape{\headmark}}
% odd pages header
\rohead{\pagemark}
\lohead{\upshape{\headmark}}
% make foot empty
\ofoot{}
\cfoot{}
\ifoot{}


% If the pre-defined template style 'runin' is to be used (or any other non-
% default predefined template style, for that matter), then we first need to
% load the 'layouts' style file. See subsection 13.2 (Templates Provided by
% the Package) for more details on this.
% However, for our purposes, it should be enough to keep the default template
% and only change the exercise headings command from the default \subsection*
% to \paragraph*.
% There is also a slight font difference: runin uses the text font and makes
% the text bold via \textbf, whereas \paragraph* uses KOMA’s headings font,
% which is sans serif by default.

% \loadxsimstyle{layouts}

\xsimsetup{
	path = {exercises},
	exercise/heading = {\paragraph*},
	exercise/within = {chapter},
	exercise/the-counter = {\thechapter.\arabic{exercise}}
	%exercise/template = {runin},
}

\crefname{exercise}{Exercise}{Exercises}
\Crefname{exercise}{Exercise}{Exercises}

\definecolor{LinkRed}{HTML}{80171F}
\hypersetup{
	pdfauthor  = {Harold Abelson, Gerald Jay Sussman, Julie Sussman},
	pdftitle   = {Structure and Interpretation of Computer Programs, 2nd ed.},
	pdfsubject = {computer science, programming, abstraction},
	colorlinks = true,
	linkcolor  = LinkRed,
	urlcolor   = LinkRed,
}

% Quotes at the beginning of chapters
\renewcommand{\dictumwidth}{0.7\linewidth}
\renewcommand{\dictumrule}{\vspace{0.5em}}
\renewcommand{\dictumauthorformat}[1]{#1}
\renewcommand{\raggeddictumauthor}{\raggedright}
\addtokomafont{dictumtext}{\rmfamily}
\addtokomafont{dictumauthor}{\upshape}

% Document colors
\definecolor{DropCapViolet}{HTML}{9090C0}

\usemintedstyle{default}
\newminted[scheme]{scheme}{autogobble, escapeinside=~~}
\newminted[smallscheme]{scheme}{autogobble, escapeinside=~~}
\newminted[example]{text}{autogobble}
\newminted[smallexample]{text}{autogobble}
\newmintinline[inlinescheme]{scheme}{escapeinside=~~}
% some of the colors included in the style
% extracted with a color picker
\definecolor{DefaultVariable}{HTML}{19177D}
\definecolor{DefaultProcedure}{HTML}{0000FF}

\newtheorem*{theorem}{Theorem}

\usepackage{lettrine}  % adds commands that make drop capitals
\renewcommand{\LettrineFontHook}{\rmfamily\mdseries\color{DropCapViolet}}
\renewcommand{\DefaultLraise}{0.00}
\renewcommand{\DefaultLoversize}{0.02}
\renewcommand{\DefaultLhang}{0.12}
\setlength{\DefaultFindent}{1pt}
\setlength{\DefaultNindent}{0em}

% table of contents

% We mimic the look of the table of contents (toc) of the original printing.
% This entails the following:
% - Chapters (level 0), sections (level 1), subsections (level 2) and
%   subsubsections (level 3) are numbered,
% - but only chapters, sections and subsections appear in the toc.
% In the table of content, we need the following:
% - Subsections have the same indentation as sections.
% - Section numbers have the same width (including the horizontal space
%   between the number and the followeng section title) as subsection numbers.
% - There is additional space before each section entry, which visually groups
%   together all subsections belonging to the same section into a block.
% - Reduced space between subsection numbers and the following subsection
%   title when compared to the standard KOMA values.
% We also need to slightly increase the width afforded to page numbers, because
% otherwise the page number 'xxv' for the Acknowledgements is too large,
% resulting in an overfull hbox warning (even though the hbox isn’t visible).
%
% Our method  of configuration is taken from Chapter 15 of the KOMA script
% manual (Managing Content Lists with tocbasics), and in particular from
% Section 15.3 (Configuring Content-List Entries)

\setcounter{secnumdepth}{3}

\setcounter{tocdepth}{2}

\DeclareTOCStyleEntry[
	indent:=section,
	numwidth+=-0.7em
]{tocline}{subsection}
\DeclareTOCStyleEntry[
	numwidth:=subsection,
	beforeskip = 0.5em plus 1pt % default for chapter is 1em plus 1pt
]{tocline}{section}
\DeclareTOCStyleEntry[
	pagenumberwidth+=1pt
	% the default value is 1.55em, set in the primive LaTeX macro @pnumwidth
]{tocline}{chapter}


% general spacing

\frenchspacing
\binoppenalty = \maxdimen % breaking of binary operators
\relpenalty   = \maxdimen % breaking of relation symbols
\widowpenalty = \maxdimen
\clubpenalty  = \maxdimen

\makeindex

\setlist[description, 1]{
	leftmargin = *,
	labelsep = 0pt
}


\newcommand{\acronym}[1]{\textsc{\fontspec[Numbers={OldStyle}]{Libertinus Serif}\MakeLowercase{#1}}}
\newcommand{\booktitle}{\emph}
\newcommand{\dollar}[1]{\$#1}
\newcommand{\heading}[1]{{\sffamily\bfseries #1}}
\newcommand{\newterm}[1]{\index{#1}\emph{#1}}
\newcommand{\nth}[1]{#1}
\newcommand{\outprint}[1]{{\fontseries{l}\selectfont\textsl{#1}}}

\newcommand{\bitcode}{\texttt}
\newcommand{\code}{\texttt}
\newcommand{\dark}[1]{#1}
\newcommand{\cvar}{\color{DefaultVariable}\var}
\newcommand{\cproc}{\color{DefaultProcedure}\var}
\newcommand{\ind}[1]{\textsubscript{\ttfamily \indint{#1}}}
\newcommand{\indint}[1]{\IfInteger{#1}{\textup{#1}}{#1}}
\newcommand{\var}[1]{\textsl{\texttt{#1}}}

\newcommand{\deriv}[2]{\frac{\mathrm{d} #1}{\mathrm{d} #2}}

\DeclareMathOperator{\Angle}{Angle}
\DeclareMathOperator{\Imagpart}{Imaginary-part}
\DeclareMathOperator{\Magnitude}{Magnitude}
\DeclareMathOperator{\Fib}{Fib}
\DeclareMathOperator{\Realpart}{Real-part}

\DeclarePairedDelimiter{\abs}{\lvert}{\rvert}
